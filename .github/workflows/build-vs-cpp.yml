name: Build Visual Studio C++ Project

on:
  workflow_call:
    inputs:
      solution-path:
        description: 'Path to the Visual Studio solution (.sln) or project (.vcxproj) file'
        required: true
        type: string
      configuration:
        description: 'Build configuration (e.g., Debug, Release)'
        required: false
        type: string
        default: 'Release'
      platform:
        description: 'Build platform (e.g., x64, Win32, ARM64)'
        required: false
        type: string
        default: 'x64'
      vs-version:
        description: 'Visual Studio version (e.g., 2022, 2019). Use VS 17.x for VS 2022.'
        required: false
        type: string
        default: '17.0'
      build-args:
        description: 'Additional MSBuild arguments'
        required: false
        type: string
        default: ''
      enable-cache:
        description: 'Enable caching of build artifacts'
        required: false
        type: boolean
        default: true
      run-tests:
        description: 'Run tests after build'
        required: false
        type: boolean
        default: false
      test-executable:
        description: 'Path to test executable (required if run-tests is true)'
        required: false
        type: string
        default: ''
      upload-artifacts:
        description: 'Upload build artifacts'
        required: false
        type: boolean
        default: false
      artifact-name:
        description: 'Name for the uploaded artifact'
        required: false
        type: string
        default: 'build-output'
      artifact-path:
        description: 'Path to artifacts to upload'
        required: false
        type: string
        default: ''
    outputs:
      build-status:
        description: 'Build status (success or failure)'
        value: ${{ jobs.build.outputs.status }}

jobs:
  build:
    runs-on: windows-2022
    outputs:
      status: ${{ steps.build-step.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: ${{ inputs.platform == 'ARM64' && 'arm64' || (inputs.platform == 'Win32' && 'x86' || 'x64') }}
          vs-version: ${{ inputs.vs-version == '2022' && '17.0' || (inputs.vs-version == '2022.0' && '17.0' || inputs.vs-version) }}
      
      - name: Debug Visual Studio / MSBuild detection
        run: |
          echo === vswhere location ===
          where vswhere || echo vswhere not found
          echo === vswhere output ===
          "%ProgramData%\chocolatey\bin\vswhere.exe" -products * -requires Microsoft.Component.MSBuild -format json -latest -version 17.0 || (
            echo vswhere query failed. Trying installer path...
            "%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -products * -requires Microsoft.Component.MSBuild -format json -latest -version 17.0 || echo no vswhere output
          )
          echo === msbuild in PATH ===
          where msbuild || echo msbuild.exe not on PATH
        shell: cmd
      
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2
      
      - name: Restore NuGet packages
        run: nuget restore "${{ inputs.solution-path }}"
        shell: cmd
      
      - name: Setup cache
        if: inputs.enable-cache
        uses: actions/cache@v4
        with:
          path: |
            **/obj
            **/bin
          key: ${{ runner.os }}-msbuild-${{ inputs.configuration }}-${{ inputs.platform }}-${{ hashFiles('**/*.vcxproj', '**/*.sln') }}
          restore-keys: |
            ${{ runner.os }}-msbuild-${{ inputs.configuration }}-${{ inputs.platform }}-
            ${{ runner.os }}-msbuild-
      
      - name: Build project
        id: build-step
        run: |
          msbuild "${{ inputs.solution-path }}" /p:Configuration=${{ inputs.configuration }} /p:Platform=${{ inputs.platform }} /m /v:minimal ${{ inputs.build-args }}
        shell: cmd
      
      - name: Run tests
        if: inputs.run-tests && inputs.test-executable != ''
        run: |
          if exist "${{ inputs.test-executable }}" (
            "${{ inputs.test-executable }}"
          ) else (
            echo Error: Test executable not found at ${{ inputs.test-executable }}
            exit /b 1
          )
        shell: cmd
      
      - name: Upload build artifacts
        if: inputs.upload-artifacts && inputs.artifact-path != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}
          retention-days: 7
